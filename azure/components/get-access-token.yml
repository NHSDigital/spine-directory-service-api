parameters:
  - name: serviceName
    type: string
    
steps:
  - bash: |
      curl -X POST https://login.apigee.com/oauth/token \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -H "Accept: application/json;charset=utf-8" \
        -H "Authorization: Basic ZWRnZWNsaTplZGdlY2xpc2VjcmV0" \
        -d "username=$(APIGEE_USERNAME)&password=$(APIGEE_PASSWORD)&mfa_token=$(secret.MFACode)&grant_type=password" | jq -e .access_token > .token

      # Set token into variable
      echo "##vso[task.setvariable variable=secret.AccessToken;issecret=true]`cat .token`"
    displayName: 'Deploy ${{ parameters.serviceName }} > Get Access Token'
