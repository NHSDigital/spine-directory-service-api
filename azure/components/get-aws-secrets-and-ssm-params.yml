parameters:
  - name: SECRET_IDS
    type: string
    default: ''
  - name: PARAM_NAMES
    type: string
    default: ''

steps:
  - task: DownloadSecureFile@1
    name: aws_config
    inputs:
      secureFile: ptl_aws_config
  
  - bash: |
      mkdir -p ~/.aws
      mv $(aws_config.secureFilePath) ~/.aws/config
      chmod 400 ~/.aws/config
    displayName: "Get AWS config"
  
  - bash: |
      set -euo pipefail

      for secret_id in ${{ parameters.SECRET_IDS }}
      do
          secret_name=$(expr match ${secret_id} '.*/\(.*\)')
          secret_value=$(aws --profile apm_ptl secretsmanager get-secret-value --secret-id ${secret_id} --query SecretString --output text)
          echo "##vso[task.setvariable variable=${secret_name};issecret=true]${secret_value}"
          unset secret_name secret_value
      done
    displayName: 'Get AWS secrets'
  
  - bash: |
      set -euo pipefail
      
      export SERVICE_ARTIFACT_NAME=`ls $(Pipeline.Workspace)/$(SERVICE_NAME)`
      echo "##vso[task.setvariable variable=SERVICE_ARTIFACT_NAME]$SERVICE_ARTIFACT_NAME"
      export PARAM_NAMES="${{ parameters.PARAM_NAMES }}"
      # AWS cli can handle getting up to 10 params in a single call.
      params=($(aws --profile apm_ptl ssm get-parameters \
                --names ${PARAM_NAMES} \
                --query 'Parameters[][Name, Value]' --output text))
      for i in $(seq 0 2 $((${#params[@]}-2))); do
        param_name=$(expr match ${params[i]} '.*/\(.*\)')
        param_value=${params[$((i+1))]}
        echo "##vso[task.setvariable variable=${param_name}]${param_value}"
        unset param_name param_value
      done
    displayName: 'Get AWS SSM parameters'
