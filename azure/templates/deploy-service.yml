parameters:
  - name: SERVICE_NAME_SUFFIX
    default: ''
    type: string

steps:
  - template: ../components/setup-terraform.yml
    parameters:
      useCustomTerraform: $(USE_CUSTOM_TERRAFORM)

  - template: ../components/get-mfa-code.yml
    parameters:
      serviceName: $(SERVICE_NAME)
      apigeeOTPKey: $(APIGEE_OTP_KEY)

  - template: ../components/get-access-token.yml
    parameters:
      serviceName: $(SERVICE_NAME)

  - bash: |
      set -euo pipefail

      echo "!!! If you get an error here, it is because '$(SERVICE_NAME)' is not the source alias name of the artifact"
      export SERVICE_ARTIFACT_NAME=`ls $(Pipeline.Workspace)/$(SERVICE_NAME)`
      echo "##vso[task.setvariable variable=SERVICE_ARTIFACT_NAME]$SERVICE_ARTIFACT_NAME"
      echo "Deploying $SERVICE_ARTIFACT_NAME to $(SERVICE_BASE_PATH) on $(ENV_URL)"
      echo "Using custom terraform: $(USE_CUSTOM_TERRAFORM)"
    displayName: 'Deploy $(SERVICE_NAME) > Deploy Info'

  - bash: |
      set -euo pipefail

      export PROXIES_DIR="$(Pipeline.Workspace)/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/proxies"
      export SERVICE_BASE_PATH="$(SERVICE_BASE_PATH)"
      export APIGEE_ENVIRONMENT="$(APIGEE_ENVIRONMENT)"

      make --no-print-directory -C utils/ansible template-proxies
    displayName: 'Deploy $(SERVICE_NAME) > template proxies'

  - bash: |
      set -euo pipefail

      export SERVICE_DIR=`realpath "$(Pipeline.Workspace)/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)"`
      export PROXY_DIR="$SERVICE_DIR/proxies/$(PROXY_NAME)"

      service_name_parts=($(SERVICE_NAME) $(APIGEE_ENVIRONMENT) ${{ parameters.SERVICE_NAME_SUFFIX }})
      service_name=$(printf "%s-" ${service_name_parts[@]}) # join with dashes (ignores empty suffix)
      export SERVICE_NAME=${service_name::-1} # remove trailing dash

      export SERVICE_BASE_PATH="$(SERVICE_BASE_PATH)"
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
      export PRODUCT_DISPLAY_NAME="Identity Service"
      export PRODUCT_DESCRIPTION="OAuth provider for NHS ID"

      cd utils
      poetry run ansible-playbook ansible/deploy-apigee-proxy.yml
      poetry run ansible-playbook ansible/deploy-apigee-product.yml
    displayName: 'Deploy $(SERVICE_NAME) > Deploy Proxy and Product'
