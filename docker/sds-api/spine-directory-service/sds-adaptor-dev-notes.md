## SDS Adaptor - Developer Notes

The following sections are intended to provide the necessary info on how to configure and run the SDS adaptor for development. As of now it was tested/used on Mac (OS X).

### Pre-requisites

* You'll need to have a connection to Spine. For testing purposes, you can use [Opentest](https://nhs-digital-opentest.github.io/Welcome/index.html).
See [Setup an OpenTest connection](../setup-opentest.md) for details.

* Ensure you have [Pipenv](https://docs.pipenv.org/en/latest/) installed
  ```
  brew install pipenv
  ```
  and on your path.

* Ensure you have [IntelliJ IDEA](https://www.jetbrains.com/idea/) installed

### Set up

Within directory of the `./sds` project run:
```
pipenv install --dev
```
After installing/configuring dependencies with pipenv, open IntelliJ IDEA project using root path `spine-directory-service`.

Make sure `./sds` module interpreter is configured with Pipenv pointing to proper virtual environtments created by `pipenv install` commands executed above (run `pipenv --venv` to check the virtualenv directory of each module)

Make a copy of `spine-directory-service-env-example.yml` as `spine-directory-service-env.yml` (this file has already been added to .gitignore) and fill it with data (mostly certificates - be vary of indentation for them) obtained earlier for OpenTest access

Last step is to add new Python Run Configuration in Pycharm:
1. Point script path to `main.py` and `sds` module
2. Switch to EnvFile tab
3. Enable EnvFile plugin and add yaml file you edited and saved earlier.
4. Make sure your connection to OpenTest is active
4. Project is ready to run!

## Running the SDS Adaptor locally
Follow the steps described in
[running an SDS Adaptor locally](running-sds-adaptor-locally.md) for how to run the required set of docker containers locally.

## API docs
<!-- TODO: update to point to generator -->
SDS is documented using
[OpenAPI](https://spec.openapis.org/oas/v3.0.2). These docs can be generated by running `pipenv run generate-openapi-docs` in
the `mhs/outbound` folder. The output of this command can be saved to a file, then transformed into another format (eg client
SDK, HTML docs) using various OpenAPI tools available online. For example:

```bash
pipenv run generate-openapi-docs > test.json
docker run --rm -v ${PWD}:/local  openapitools/openapi-generator-cli generate -g html -i /local/test.json -o /local/out/html
```

generates HTML docs. An invocation of this command can be seen
[here](https://htmlpreview.github.io/?https://github.com/nhsconnect/integration-adaptors/blob/develop/mhs/outbound/openapi-docs.html).

### Environment Variables
SDS takes a number of environment variables when it is run. These are:
* `SDS_SERVER_PORT` Server port on which to run SDS on
* `SDS_LOG_LEVEL` This is required to be set to one of: `INFO`, `WARNING`, `ERROR` or `CRITICAL`, where `INFO` displays
the most logs and `CRITICAL` displays the least. Note: Setting this value to one of the more detailed 'standard' Python
log levels (such as `DEBUG` or `NOTSET`) may result in the libraries used by this application logging details that
contain sensitive information such as the content of messages being sent.
* `SDS_LOG_FORMAT` Allows overwriting default log format. Check default log format at [integration_adaptors_logger.py](sds/utilities/integration_adaptors_logger.py)
* `SDS_SECRET_CLIENT_CERT` Your endpoint certificate
* `SDS_SECRET_CLIENT_KEY` Your endpoint private key
* `SDS_SECRET_CA_CERTS` Should include the following in this order: endpoint issuing subCA certificate, root CA Certificate.
* `SDS_LDAP_URL` The URL to communicate with SDS on. e.g. `ldaps://example.com`
* `SDS_LDAP_SEARCH_BASE` The LDAP location to use as the base of SDS searches, e.g. `ou=services,o=nhs`. Should not contain whitespace.
* `SDS_LDAP_DISABLE_TLS` An optional flag that can be set to disable TLS for LDAP
connections. *Must* be set to exactly `True` for TLS to be disabled.
* `SDS_LDAP_CONNECTION_RETRIES` Number of retries when LDAP connection cannot be established
* `SDS_LDAP_CONNECTION_TIMEOUT_IN_SECONDS` Number of seconds to wait for establishing LDAP connection
* `SDS_LDAP_LAZY_CONNECTION` use lazy connection from spine route lookup component to SPINE LDAP service

Note that if you are using Opentest, you should use the credentials you were given when you got access to set `SDS_SECRET_CLIENT_CERT`, `SDS_SECRET_CLIENT_KEY` and `SDS_SECRET_CA_CERTS`.

For offline debugging purpose following environment variables can be set:
* `SDS_LDAP_MOCK_DATA_URL_CONFIG_KEY`
* `SDS_FAKE_SPINE_URL_CONFIG_KEY`
* `SDS_AWS_PROFILE`
Check [SDS mock LDAP readme](sds/sds-mock-ldap.md)

## Running Unit Tests
Unit test can be run for each module by executing following commands within their folders:
- `pipenv run unittests` will run all unit tests.

## Coverage
- `pipenv run unittests-cov` will run all unit tests, generating a [Coverage](https://coverage.readthedocs.io/) report
in the `test-reports` directory.
- `pipenv run coverage-report` will print the coverage report generated by `unittests-cov`
- `pipenv run coverage-report-xml` will produce an XML version of the coverage report generated by `unittests-cov`, in a
[Cobertura](http://cobertura.github.io/cobertura/) compatible format
- `pipenv run coverage-report-html` will produce an HTML version of the coverage report generated by `unittests-cov`

## Running Integration Tests
See the [integration tests README](../integration-tests/README.md).
